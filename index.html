<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØ®Ù…ÙŠÙ†</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');

    :root{
      --bg-dark:#3a3a3a;
      --box-bg:#4a4a4a;
      --orange:#ff733b;
      --text-light:#ffffff;
      --green:#4CAF50;
      --red:#f44336;
    }

    *{
      box-sizing:border-box;margin:0;padding:0;
      font-family:'Tajawal',sans-serif;
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
    }
    body{
      background-color:var(--bg-dark);
      color:var(--text-light);
      height:100dvh;width:100vw;
      overflow:hidden;
      touch-action: manipulation;
    }

    #portrait-warning{
      display:none;
      position:fixed; inset:0;
      background:#000; color:#fff; z-index:9999;
      flex-direction:column; align-items:center; justify-content:center;
      text-align:center; font-size:24px; padding:20px;
    }
    @media (orientation: portrait){
      #portrait-warning{display:flex;}
      .screen{display:none !important;}
    }

    .screen{display:none;width:100%;height:100%;flex-direction:column;}
    .screen.active{display:flex;}

    .setup-container{
      margin:auto;background:var(--box-bg);padding:40px;
      border-radius:20px;text-align:center;width:min(500px,92vw);
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
    }
    .setup-container h1{color:var(--orange);margin-bottom:20px;font-size:36px;}
    input{
      width:100%;padding:15px;font-size:24px;margin-bottom:20px;
      border-radius:10px;border:2px solid #666;background:#333;
      color:white;text-align:center;outline:none;
    }
    .start-btn{
      background:var(--orange);color:white;padding:15px 40px;font-size:26px;
      border:none;border-radius:10px;cursor:pointer;font-weight:bold;width:100%;
    }

    .header-bar{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 30px;background:#2a2a2a;border-bottom:2px solid #111;
      gap:10px;
    }
    .turn-badge{
      background:var(--orange);padding:5px 20px;border-radius:20px;
      font-size:22px;font-weight:bold;white-space:nowrap;
    }
    .game-title{font-size:28px;font-weight:bold;opacity:.9;}

    .main-board{
      flex-grow:1;display:flex;justify-content:center;align-items:center;
      padding:20px;gap:20px;
    }
    .grid-section{
      display:grid;grid-template-columns:repeat(3,1fr);
      gap:15px;width:40%;
    }
    .point-box{
      background:var(--box-bg);color:white;border:none;
      border-radius:15px;font-size:40px;font-weight:900;
      cursor:pointer;display:flex;align-items:center;justify-content:center;
      aspect-ratio:4/3;box-shadow:0 5px 10px rgba(0,0,0,0.3);
      transition:.2s;
    }
    .point-box:active{transform:scale(.95);}
    .point-box.disabled{visibility:hidden;}

    .center-image{
      width:20%;display:flex;justify-content:center;align-items:center;
      background:#d4e6f1;border-radius:15px;aspect-ratio:3/4;
      box-shadow:inset 0 0 20px rgba(0,0,0,0.1);
    }
    .center-image svg{width:70%;fill:#333;}

    .footer-bar{
      display:flex;justify-content:space-between;align-items:flex-end;
      padding:15px 30px;background:#2a2a2a;border-top:2px solid #111;
    }
    .team-panel{text-align:center;width:300px;}
    .team-name{font-size:24px;font-weight:bold;margin-bottom:5px;}
    .score-box{
      background:var(--orange);border-radius:25px;padding:5px 20px;
      display:flex;justify-content:center;align-items:center;
      font-size:32px;font-weight:bold;
    }

    .overlay-screen{
      position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:50;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:20px;
    }
    .overlay-screen h1{font-size:80px;color:var(--orange);margin:30px 0;text-align:center;}
    .overlay-screen p{font-size:30px;color:#ccc;text-align:center;}
    .btn-large{
      background:var(--orange);color:white;padding:20px 50px;font-size:30px;
      border:none;border-radius:15px;cursor:pointer;font-weight:bold;
    }

    #canvas-screen{
      position:fixed;inset:0;background:white;z-index:100;display:none;
    }

    canvas{
      width:100vw;height:100dvh;display:block;
      touch-action:none;cursor:crosshair;
    }

    /* Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ø£Ø¹Ù„Ù‰: ÙŠØ³Ø§Ø± (Ø£Ù„ÙˆØ§Ù†+Ù…Ù…Ø­Ø§Ø©) + ÙˆØ³Ø· (Ø£Ø²Ø±Ø§Ø±) + ÙŠÙ…ÙŠÙ† (Ø§Ù„ÙˆÙ‚Øª) */
    .top-tools{
      position:absolute;top:14px;left:14px;right:14px;
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;z-index:101;
      pointer-events:none; /* Ù†Ø®Ù„ÙŠ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù„ÙŠ Ø¯Ø§Ø®Ù„Ù‡Ø§ ØªØ´ØªØºÙ„ */
    }
    .tool-group{
      display:flex;align-items:center;gap:10px;
      pointer-events:auto;
    }

    .float-btn{
      background:#333;color:white;padding:12px 18px;font-size:20px;
      border:2px solid #555;border-radius:999px;cursor:pointer;font-weight:bold;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      white-space:nowrap;
    }
    .float-btn.action{background:var(--orange);border-color:var(--orange);}
    .float-btn.danger{background:#111;border-color:#111;color:#fff;}
    .float-btn.active{
      outline:3px solid rgba(255,115,59,.55);
      outline-offset:2px;
    }

    .timer-badge{
      background:#111;color:#fff;
      border:2px solid #333;
      padding:10px 16px;border-radius:999px;
      font-size:20px;font-weight:900;white-space:nowrap;
      pointer-events:auto;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
    }
    .timer-badge.done{
      background:#f44336;border-color:#f44336;
    }

    .palette{
      background:rgba(0,0,0,.08);
      border:2px solid rgba(0,0,0,.12);
      padding:8px;border-radius:999px;
      display:flex;gap:8px;align-items:center;
      backdrop-filter: blur(6px);
    }
    .swatch{
      width:28px;height:28px;border-radius:999px;border:2px solid rgba(0,0,0,.25);
      cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    .swatch.selected{
      transform:scale(1.12);
      border-color:#000;
    }

    #result-modal{
      position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;
      display:none;flex-direction:column;align-items:center;justify-content:center;
      padding:20px;
    }
    .result-box{
      background:var(--box-bg);padding:40px;border-radius:20px;text-align:center;
      width:min(560px,92vw);
    }
    .result-box h2{font-size:40px;margin-bottom:30px;color:white;line-height:1.2;}
    .result-actions{display:flex;gap:20px;justify-content:center;flex-wrap:wrap;}
    .btn-correct{background:var(--green);color:white;border:none;padding:15px 30px;font-size:24px;border-radius:10px;cursor:pointer;}
    .btn-wrong{background:var(--red);color:white;border:none;padding:15px 30px;font-size:24px;border-radius:10px;cursor:pointer;}
  </style>
</head>

<body>
  <div id="portrait-warning">
    <span style="font-size:42px">ğŸ”„</span>
    ÙŠØ±Ø¬Ù‰ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø§Ù„Ø¢ÙŠØ¨Ø§Ø¯ Ø£Ùˆ Ø§Ù„Ø¢ÙŠÙÙˆÙ†) Ø¨Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ÙŠ Ù„Ù„Ø¹Ø¨
  </div>

  <div id="setup-screen" class="screen active">
    <div class="setup-container">
      <h1>ğŸ¨ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø³Ù…</h1>
      <input type="text" id="team1-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„" value="Ø§Ù„ÙØ±ÙŠÙ‚ 1">
      <input type="text" id="team2-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" value="Ø§Ù„ÙØ±ÙŠÙ‚ 2">
      <button class="start-btn" onclick="startGame()">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø©</button>
    </div>
  </div>

  <div id="dashboard-screen" class="screen">
    <div class="header-bar">
      <div>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±Ø³Ù… | ØªØ­Ø¯ÙŠ Ø§Ù„ÙØ±Ù‚</div>
      <div class="game-title"></div>
      <div class="turn-badge">Ø¯ÙˆØ±: <span id="current-turn-name"></span></div>
    </div>

    <div class="main-board">
      <div class="grid-section">
        <button class="point-box" onclick="startWord(200, this)">200</button>
        <button class="point-box" onclick="startWord(200, this)">200</button>
        <button class="point-box" onclick="startWord(200, this)">200</button>
        <button class="point-box" onclick="startWord(400, this)">400</button>
        <button class="point-box" onclick="startWord(400, this)">400</button>
        <button class="point-box" onclick="startWord(400, this)">400</button>
        <button class="point-box" onclick="startWord(600, this)">600</button>
        <button class="point-box" onclick="startWord(600, this)">600</button>
        <button class="point-box" onclick="startWord(600, this)">600</button>
      </div>

      <div class="center-image">
        <svg viewBox="0 0 24 24">
          <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
        </svg>
      </div>

      <div class="grid-section">
        <button class="point-box" onclick="startWord(200, this)">200</button>
        <button class="point-box" onclick="startWord(200, this)">200</button>
        <button class="point-box" onclick="startWord(200, this)">200</button>
        <button class="point-box" onclick="startWord(400, this)">400</button>
        <button class="point-box" onclick="startWord(400, this)">400</button>
        <button class="point-box" onclick="startWord(400, this)">400</button>
        <button class="point-box" onclick="startWord(600, this)">600</button>
        <button class="point-box" onclick="startWord(600, this)">600</button>
        <button class="point-box" onclick="startWord(600, this)">600</button>
      </div>
    </div>

    <div class="footer-bar">
      <div class="team-panel">
        <div class="team-name" id="t1-name-display">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„</div>
        <div class="score-box" id="t1-score">0</div>
      </div>
      <div style="font-size:20px;opacity:.5;">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØ®Ù…ÙŠÙ†</div>
      <div class="team-panel">
        <div class="team-name" id="t2-name-display">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
        <div class="score-box" id="t2-score">0</div>
      </div>
    </div>
  </div>

  <div id="word-screen" class="overlay-screen" style="display:none;">
    <p>Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù‡ÙŠ:</p>
    <h1 id="the-word"></h1>
    <p style="margin-bottom:20px;">Ø§Ù„ÙˆÙ‚Øª: <span id="time-display" style="color:var(--orange);"></span> Ø«Ø§Ù†ÙŠØ©</p>
    <button class="btn-large" onclick="openCanvas()">Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø³Ù… â±ï¸</button>
  </div>

  <div id="canvas-screen">
    <div class="top-tools">
      <!-- ÙŠØ³Ø§Ø±: Ø£Ù„ÙˆØ§Ù† + Ù…Ù…Ø­Ø§Ø© -->
      <div class="tool-group">
        <div class="palette" id="palette"></div>
        <button class="float-btn danger" id="eraserBtn" onclick="toggleEraser()">Ù…Ù…Ø­Ø§Ø©</button>
      </div>

      <!-- ÙˆØ³Ø·: Ø£Ø²Ø±Ø§Ø± -->
      <div class="tool-group">
        <button class="float-btn action" onclick="showAnswer()">Ø£Ø¸Ù‡Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
        <button class="float-btn" onclick="clearCanvas()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>

      <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„ÙˆÙ‚Øª -->
      <div class="tool-group">
        <div class="timer-badge" id="canvas-timer">01:00</div>
      </div>
    </div>

    <canvas id="drawingBoard"></canvas>
  </div>

  <div id="result-modal">
    <div class="result-box">
      <h2 id="reveal-word-text"></h2>
      <div class="result-actions">
        <button class="btn-correct" onclick="endRound(true)">Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ…</button>
        <button class="btn-wrong" onclick="endRound(false)">ØªØ®Ø·ÙŠ / Ø®Ø·Ø£ âŒ</button>
      </div>
    </div>
  </div>

  <script>
    let teams = [{name:'',score:0},{name:'',score:0}];
    let currentTeamIndex = 0;
    let currentPoints = 0;
    let currentWord = "";

    const words = {
      200: ['Ø¨ÙŠØª','Ø´Ø¬Ø±Ø©','Ø´Ù…Ø³','Ù‚Ù…Ø±','ØªÙØ§Ø­Ø©','ÙƒØ±Ø³ÙŠ'],
      400: ['Ø³ÙŠØ§Ø±Ø©','Ø¹Ù†Ø¨','Ø·ÙŠØ§Ø±Ø©','Ø³Ø§Ø¹Ø©','Ù†Ø¸Ø§Ø±Ø©','ÙƒØªØ§Ø¨'],
      600: ['Ù„Ø§Ø¨ØªÙˆØ¨','Ù…Ø³ØªØ´ÙÙ‰','ÙØ¶Ø§Ø¡','ÙƒÙ‡Ø±Ø¨Ø§Ø¡','ØªÙ„ÙØ²ÙŠÙˆÙ†','Ù…Ø·Ø§Ø±']
    };

    const canvas = document.getElementById('drawingBoard');
    const ctx = canvas.getContext('2d', { willReadFrequently:false });

    // Ø±Ø³Ù… Ù†Ø§Ø¹Ù… + Ø­Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: Ù†Ø³ØªØ®Ø¯Ù… coalesced events + Ø³Ù…Ø§Ø­ÙŠØ© Ø£Ø¹Ù„Ù‰
    let isDrawing = false;
    let lastX = 0, lastY = 0;
    let drawingEnabled = true;

    // Ù…Ø¤Ù‚Øª (Ø¯Ù‚ÙŠÙ‚Ø© Ø«Ø§Ø¨ØªØ©)
    const ROUND_SECONDS = 60;
    let remaining = ROUND_SECONDS;
    let timerId = null;

    // Ø£Ù„ÙˆØ§Ù† + Ù…Ù…Ø­Ø§Ø©
    const COLORS = [
      "#000000", // Ø£Ø³ÙˆØ¯
      "#ffffff", // Ø£Ø¨ÙŠØ¶ (Ù…ÙÙŠØ¯ Ù„Ù„ØªØ­Ø¯ÙŠØ¯)
      "#ff0000", // Ø£Ø­Ù…Ø±
      "#00aaff", // Ø£Ø²Ø±Ù‚
      "#00c853", // Ø£Ø®Ø¶Ø±
      "#ff9800", // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
      "#9c27b0", // Ø¨Ù†ÙØ³Ø¬ÙŠ
      "#ffeb3b", // Ø£ØµÙØ±
      "#795548", // Ø¨Ù†ÙŠ
      "#607d8b"  // Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø²Ø±Ù‚
    ];
    let currentColor = COLORS[0];
    let isEraser = false;

    function startGame(){
      teams[0].name = document.getElementById('team1-name').value || "Ø§Ù„ÙØ±ÙŠÙ‚ 1";
      teams[1].name = document.getElementById('team2-name').value || "Ø§Ù„ÙØ±ÙŠÙ‚ 2";
      updateDashboard();
      document.getElementById('setup-screen').classList.remove('active');
      document.getElementById('dashboard-screen').classList.add('active');
    }

    function updateDashboard(){
      document.getElementById('t1-name-display').innerText = teams[0].name;
      document.getElementById('t1-score').innerText = teams[0].score;
      document.getElementById('t2-name-display').innerText = teams[1].name;
      document.getElementById('t2-score').innerText = teams[1].score;
      document.getElementById('current-turn-name').innerText = teams[currentTeamIndex].name;
    }

    function startWord(points, btnElement){
      currentPoints = points;
      btnElement.classList.add('disabled');

      // Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙŠØ¨Ù‚Ù‰ ÙŠÙ†Ø¹Ø±Ø¶ 60 Ø«Ø§Ø¨Øª
      remaining = ROUND_SECONDS;
      document.getElementById('time-display').innerText = remaining;

      const wordList = words[points] || words[200];
      currentWord = wordList[Math.floor(Math.random() * wordList.length)];

      document.getElementById('the-word').innerText = currentWord;
      document.getElementById('word-screen').style.display = 'flex';
    }

    function openCanvas(){
      document.getElementById('word-screen').style.display = 'none';
      document.getElementById('canvas-screen').style.display = 'block';

      // ØªÙ‡ÙŠØ¦Ø© Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù†
      buildPalette();

      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ø¯Ù‚Ø© (Ø¨Ø¯ÙˆÙ† Ù…Ø´ÙƒÙ„Ø© scale Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…)
      resizeCanvas();

      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ù„Ù…
      setupBrush();

      clearCanvas();
      startTimer();
      drawingEnabled = true;
      updateTimerUI();
    }

    function resizeCanvas(){
      const dpr = window.devicePixelRatio || 1;
      const w = window.innerWidth;
      const h = window.innerHeight;

      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);

      // Ù…Ù‡Ù…: ØµÙØ± Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø«Ù… Ø§Ø¶Ø¨Ø·Ù‡ (Ø¨Ø¯Ù„ ctx.scale Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…)
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener('resize', () => {
      if (document.getElementById('canvas-screen').style.display === 'block') {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¬ÙŠÙ… Ø¨Ø¯ÙˆÙ† ÙÙ‚Ø¯Ø§Ù† ÙƒØ§Ù…Ù„ØŸ (Ù‡Ù†Ø§ Ø¨Ù†Ù…Ø³Ø­ Ù„ØªØ¨Ø³ÙŠØ· ÙˆÙ…Ù†Ø¹ Ù…Ø´Ø§ÙƒÙ„)
        resizeCanvas();
        setupBrush();
      }
    });

    function setupBrush(){
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.miterLimit = 2;

      // Ø®Ø· Ø£ÙˆØ¶Ø­ ÙˆØ³Ù„Ø³
      ctx.lineWidth = 7;
      ctx.strokeStyle = currentColor;
      ctx.fillStyle = currentColor;

      // smooth-ish
      ctx.imageSmoothingEnabled = true;
    }

    function buildPalette(){
      const palette = document.getElementById('palette');
      palette.innerHTML = "";

      COLORS.forEach((c, idx) => {
        const btn = document.createElement('button');
        btn.className = 'swatch' + (idx === 0 ? ' selected' : '');
        btn.style.background = c;
        btn.setAttribute('aria-label', 'Ù„ÙˆÙ†');
        btn.addEventListener('click', () => selectColor(c, btn), { passive:true });
        palette.appendChild(btn);
      });

      // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ù‚Ù„Ù…
      isEraser = false;
      document.getElementById('eraserBtn').classList.remove('active');
      currentColor = COLORS[0];
      setupBrush();
    }

    function selectColor(color, el){
      // Ù„Ùˆ ÙƒÙ†Øª Ù…Ù…Ø­Ø§Ø© ÙˆØ±Ø­Øª Ø§Ø®ØªØ±Øª Ù„ÙˆÙ† -> ÙŠØ±Ø¬Ø¹ Ù‚Ù„Ù…
      isEraser = false;
      document.getElementById('eraserBtn').classList.remove('active');

      currentColor = color;
      // ØªØ­Ø¯ÙŠØ« selected
      document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
      el.classList.add('selected');

      setupBrush();
    }

    function toggleEraser(){
      isEraser = !isEraser;
      const b = document.getElementById('eraserBtn');
      b.classList.toggle('active', isEraser);

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù…Ø­Ø§Ø©: ØªÙ…Ø³Ø­ Ø¬Ø²Ø¡ (destination-out)
      if (isEraser) {
        // Ù„Ø§ Ù†ØºÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø¨Ø§Ù„ÙŠØª
      }
    }

    // ---- Timer ----
    function startTimer(){
      stopTimer();
      remaining = ROUND_SECONDS;
      updateTimerUI();

      timerId = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          remaining = 0;
          updateTimerUI(true);
          stopTimer();
          stopDrawingHard(); // ÙŠÙˆÙ‚Ù Ø§Ù„Ø±Ø³Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
          // ÙŠÙØªØ­ Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠ
          showAnswer();
        } else {
          updateTimerUI();
        }
      }, 1000);
    }

    function stopTimer(){
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    function updateTimerUI(done=false){
      const t = document.getElementById('canvas-timer');
      const mm = String(Math.floor(remaining / 60)).padStart(2,'0');
      const ss = String(remaining % 60).padStart(2,'0');
      t.textContent = `${mm}:${ss}`;
      t.classList.toggle('done', done || remaining === 0);
    }

    function stopDrawingHard(){
      drawingEnabled = false;
      isDrawing = false;
    }

    // ---- Drawing (Ø³Ù„Ø³ + ÙŠØ¯Ø¹Ù… Ù†Ù‚Ø§Ø· Ø³Ø±ÙŠØ¹Ø©) ----
    function getPointerPos(e){
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function applyStroke(x1, y1, x2, y2){
      if (isEraser) {
        ctx.save();
        ctx.globalCompositeOperation = 'destination-out';
        ctx.lineWidth = 18; // Ù…Ù…Ø­Ø§Ø© Ø£ÙƒØ¨Ø± Ø´ÙˆÙŠ
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        ctx.restore();
        setupBrush(); // ÙŠØ±Ø¬Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù‚Ù„Ù… Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ†
        return;
      }

      // Ù‚Ù„Ù…: Ø±Ø³Ù… Ù†Ø§Ø¹Ù…
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
    }

    function startDrawing(e){
      if (!drawingEnabled) return;
      e.preventDefault();
      canvas.setPointerCapture?.(e.pointerId);

      isDrawing = true;
      const pos = getPointerPos(e);
      lastX = pos.x; lastY = pos.y;

      // Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ©
      if (isEraser) {
        applyStroke(lastX, lastY, lastX + 0.01, lastY + 0.01);
      } else {
        ctx.beginPath();
        ctx.arc(lastX, lastY, ctx.lineWidth / 2, 0, Math.PI * 2);
        ctx.fillStyle = currentColor;
        ctx.fill();
      }
    }

    function draw(e){
      if (!isDrawing || !drawingEnabled) return;
      e.preventDefault();

      // Ù‡Ø°Ø§ Ù‡Ùˆ Ø­Ù„ â€œØ§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù…Ø§ ØªØ·Ù„Ø¹â€ Ø¹Ù„Ù‰ iOS: Ù†Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…ØªØ¬Ù…Ø¹Ø©
      const events = (typeof e.getCoalescedEvents === 'function')
        ? e.getCoalescedEvents()
        : [e];

      for (const ev of events) {
        const pos = getPointerPos(ev);
        applyStroke(lastX, lastY, pos.x, pos.y);
        lastX = pos.x; lastY = pos.y;
      }
    }

    function stopDrawing(e){
      isDrawing = false;
      if (e?.pointerId != null) {
        try { canvas.releasePointerCapture?.(e.pointerId); } catch {}
      }
    }

    // Ù…Ù‡Ù…: passive:false Ø¹Ø´Ø§Ù† preventDefault ÙŠÙˆÙ‚Ù Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø©
    canvas.addEventListener('pointerdown', startDrawing, { passive:false });
    canvas.addEventListener('pointermove', draw, { passive:false });
    canvas.addEventListener('pointerup', stopDrawing, { passive:false });
    canvas.addEventListener('pointercancel', stopDrawing, { passive:false });
    canvas.addEventListener('pointerout', stopDrawing, { passive:false });

    function clearCanvas(){
      // Ø§Ù…Ø³Ø­ ÙƒØ§Ù…Ù„ Ø§Ù„Ù„ÙˆØ­Ø©
      ctx.save();
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.restore();
      // ÙŠØ±Ø¬Ø¹ transform Ù…Ø¶Ø¨ÙˆØ· Ø­Ø³Ø¨ resizeCanvas
      const dpr = window.devicePixelRatio || 1;
      ctx.setTransform(dpr,0,0,dpr,0,0);
      setupBrush();
    }

    function showAnswer(){
      document.getElementById('reveal-word-text').innerText = "Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª: " + currentWord;
      document.getElementById('result-modal').style.display = 'flex';
    }

    function endRound(isCorrect){
      stopTimer();
      drawingEnabled = false;
      isDrawing = false;

      if (isCorrect) teams[currentTeamIndex].score += currentPoints;

      currentTeamIndex = currentTeamIndex === 0 ? 1 : 0;
      updateDashboard();

      document.getElementById('result-modal').style.display = 'none';
      document.getElementById('canvas-screen').style.display = 'none';
    }
  </script>
</body>
</html>
